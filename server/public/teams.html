<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–ê–î–ò ‚Äî –ß–∞—Ç—ã</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/socket.io/socket.io.js"></script>
    <script type="module">
      import { api, me, toast, initTheme, toggleTheme } from '/app.js';
      let currentUser = null; let activeChatId = null; let role = 'member'; let socket;
      const typingMap = new Map();

      function renderTyping(){
        const bar = document.getElementById('typing');
        const names = Array.from(typingMap.values());
        if (!names.length) { bar.textContent = ''; bar.style.display='none'; }
        else { bar.textContent = names.join(', ') + ' –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶'; bar.style.display='block'; }
      }
      function handleTyping(e){
        if (!socket || !activeChatId) return;
        socket.emit('typing', { chatId: activeChatId });
      }

      async function loadChats(){
        const d = await api('/api/chats');
        const list = document.getElementById('chatList');
        list.innerHTML = '';
        d.chats.forEach(c => {
          const li = document.createElement('li');
          li.className = 'row';
          li.style.justifyContent = 'space-between';
          li.innerHTML = `<div><b>${c.title}</b><div class="muted" style="font-size:12px">${c.last_message ? c.last_message.slice(0,60) : '–ë–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π'}</div></div>`;
          const btn = document.createElement('button'); btn.className='btn'; btn.textContent='–û—Ç–∫—Ä—ã—Ç—å';
          btn.addEventListener('click', ()=> openChat(c.id));
          li.appendChild(btn); list.appendChild(li);
        });
        if (!activeChatId && d.chats[0]) openChat(d.chats[0].id);
      }

      async function openChat(id){
        activeChatId = id;
        const meta = await api(`/api/chats/${id}`);
        document.getElementById('chatTitle').textContent = meta.title;
        await loadMembers();
        await loadMessages();
        if (!socket) {
          initSocket();
        } else if (socket.connected) {
          socket.emit('join', { chatId: id });
        }
        document.getElementById('composer-input').focus();
      }

      async function loadMembers(){
        const d = await api(`/api/chats/${activeChatId}/members`);
        const my = d.members.find(m => m.id === currentUser.id);
        role = my?.role || 'member';
        const rt = document.getElementById('roleTag'); if (rt) rt.textContent = role;
        const ul = document.getElementById('memberList'); ul.innerHTML='';
        const delBtn = document.getElementById('deleteBtn'); if (delBtn) delBtn.style.display = (role==='owner') ? 'inline-block' : 'none';
        d.members.forEach(u=>{
          const li = document.createElement('li');
          li.innerHTML = `<div class="row" style="justify-content:space-between">
            <div>${u.name} <span class="tag">${u.role}</span></div>
            ${ (role === 'owner' || role === 'moderator') && u.id !== currentUser.id ? `<button class="btn" data-kick="${u.id}">–ò—Å–∫–ª—é—á–∏—Ç—å</button>` : ''}
          </div>`;
          ul.appendChild(li);
        });
        // Add role selector controls dynamically (owner/moderator only)
        if (role === 'owner' || role === 'moderator') {
          const lis = ul.querySelectorAll('li');
          d.members.forEach((u, i) => {
            if (u.id === currentUser.id) return;
            const controls = lis[i]?.querySelector('.row:last-child');
            if (!controls) return;
            const sel = document.createElement('select');
            sel.setAttribute('data-role', String(u.id));
            ['member','moderator'].forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.textContent = r; if (u.role === r) opt.selected = true; sel.appendChild(opt); });
            controls.prepend(sel);
          });
        }
        ul.querySelectorAll('[data-kick]').forEach(btn => btn.addEventListener('click', async (e)=>{
          const uid = e.currentTarget.getAttribute('data-kick');
          await api(`/api/chats/${activeChatId}/members/${uid}`, { method:'DELETE' });
          toast('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª—ë–Ω'); loadMembers();
        }));
        // Change roles (owner/moderator only) ‚Äî set by re-POSTing with new role
        ul.querySelectorAll('select[data-role]').forEach(sel => sel.addEventListener('change', async (e)=>{
          const uid = e.currentTarget.getAttribute('data-role');
          const newRole = e.currentTarget.value;
          await api(`/api/chats/${activeChatId}/members`, { method:'POST', body: JSON.stringify({ userId: Number(uid), role: newRole }) });
          toast('–†–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); loadMembers();
        }));
      }

      async function loadMessages(){
        const d = await api(`/api/chats/${activeChatId}/messages`);
        const box = document.getElementById('messages'); box.innerHTML='';
        d.messages.forEach(m => addMessage(m));
        box.scrollTop = box.scrollHeight;
      }

      function addMessage(m){
        const meMsg = m.user_id === currentUser.id;
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (meMsg ? 'me' : 'other');
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${m.user_name} ‚Ä¢ ${new Date(m.created_at).toLocaleString()}`;
        const bubble = document.createElement('div'); bubble.className='bubble';
        if (m.type === 'text') bubble.innerHTML = m.content || '';
        else if (m.type === 'video') bubble.innerHTML = `<div><video controls src="${m.attachment_path}"></video><div class="muted">${m.attachment_name}</div>${m.content?('<div>'+m.content+'</div>'):''}</div>`;
        else bubble.innerHTML = `<a href="${m.attachment_path}" target="_blank">${m.attachment_name}</a>${m.content?('<div>'+m.content+'</div>'):''}`;
        wrap.appendChild(meta); wrap.appendChild(bubble);
        if (meMsg || role === 'owner' || role === 'moderator'){
          const tools = document.createElement('div'); tools.className='row'; tools.style.gap='6px'; tools.style.marginTop='4px';
          const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
          edit.addEventListener('click', async ()=>{ const nt = prompt('–ò–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', m.content || ''); if (nt === null) return; await fetch(`/api/chats/${activeChatId}/messages/${m.id}`, { method:'PUT', headers: { 'Content-Type':'application/json', Authorization: 'Bearer ' + localStorage.getItem('token') }, body: JSON.stringify({ content: nt }) }); loadMessages(); });
          const del = document.createElement('button'); del.className='btn ghost'; del.textContent='–£–¥–∞–ª–∏—Ç—å';
          del.addEventListener('click', async ()=>{ await api(`/api/chats/${activeChatId}/messages/${m.id}`, { method:'DELETE' }); loadMessages(); });
          tools.appendChild(edit); tools.appendChild(del); wrap.appendChild(tools);
        }
        document.getElementById('messages').appendChild(wrap);
      }

      function initSocket(){
        socket = io('/', { auth: { token: localStorage.getItem('token') } });
        socket.on('connect', ()=>{ if (activeChatId) socket.emit('join', { chatId: activeChatId }); });
        socket.on('message', (m)=>{ if (m.chat_id === activeChatId){ addMessage(m); const box = document.getElementById('messages'); box.scrollTop = box.scrollHeight; } });
        socket.on('message_deleted', ({ id })=> loadMessages());
        socket.on('message_updated', (m)=>{ if (m.chat_id === activeChatId) loadMessages(); });
        socket.on('typing', ({ chatId, user_id, user_name, at }) => {
          if (chatId !== activeChatId || user_id === currentUser.id) return;
          typingMap.set(user_id, user_name);
          renderTyping();
          setTimeout(()=>{ typingMap.delete(user_id); renderTyping(); }, 1500);
        });
      }

      window.addEventListener('DOMContentLoaded', async () => {
        // Bind theme/logout early so errors below do not block
        initTheme();
        const themeBtn = document.getElementById('themeBtn');
        if (themeBtn) themeBtn.addEventListener('click', toggleTheme);
        const lb = document.getElementById('logoutBtn');
        if (lb) lb.addEventListener('click', ()=>{ localStorage.removeItem('token'); location.href='/'; });

        currentUser = await me(); if (!currentUser) return location.href = '/';
        document.getElementById('userTag').textContent = `${currentUser.name}`;
        try { await loadChats(); } catch (e) { toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã','error'); }

        // Create group chat
        const ngf = document.getElementById('newGroupForm');
        if (ngf) ngf.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const f = new FormData(ngf);
          const title = (f.get('title')||'').toString().trim();
          if (!title) return;
          await api('/api/chats', { method:'POST', body: JSON.stringify({ title, is_group: 1, memberIds: [] }) });
          toast('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞'); ngf.reset(); loadChats();
        });

        // Create direct chat by email only
        const ndf = document.getElementById('newDMForm');
        if (ndf) ndf.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const f = new FormData(ndf);
          const email = (f.get('email')||'').toString().trim();
          if (!email) return;
          const r = await api('/api/users?q=' + encodeURIComponent(email));
          if (!r.users || !r.users[0]) return toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','error');
          const other = r.users[0];
          const resp = await api('/api/chats', { method:'POST', body: JSON.stringify({ title: other.name || other.email, is_group: 0, memberIds: [other.id] }) });
          // equal rights: set creator to member
          await api(`/api/chats/${resp.id}/members`, { method:'POST', body: JSON.stringify({ userId: currentUser.id, role:'member' }) });
          toast('–õ–∏—á–Ω—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω'); ndf.reset(); loadChats();
        });
        const ci0 = document.getElementById('composer-input');
        ci0.addEventListener('input', (e)=>{ handleTyping(e); ci0.style.height='auto'; ci0.style.height = Math.min(ci0.scrollHeight, window.innerHeight*0.3) + 'px'; });
        document.getElementById('composer').addEventListener('submit', async (e)=>{
          e.preventDefault();
          if (!activeChatId) return;
          const f = new FormData(e.target);
          await fetch(`/api/chats/${activeChatId}/messages`, { method:'POST', headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }, body: f });
          e.target.reset();
        });
        document.getElementById('meetBtn').addEventListener('click', async ()=>{
          if (!activeChatId) return; const d = await api(`/api/chats/${activeChatId}/jitsi`); window.open(d.url, '_blank');
        });
        const del = document.getElementById('deleteBtn');
        if (del) del.addEventListener('click', async ()=>{
          if (!activeChatId) return; if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) return;
          await api(`/api/chats/${activeChatId}`, { method:'DELETE' });
          toast('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞'); location.href = '/teams.html';
        });
        document.getElementById('assignTab').addEventListener('click', async ()=>{
          if (!activeChatId) return; const d = await api(`/api/chats/${activeChatId}/assignments`);
          const drawer = document.getElementById('drawer');
          const fmt = (ts)=>{ const dt=new Date(ts); const dd=String(dt.getDate()).padStart(2,'0'); const mm=String(dt.getMonth()+1).padStart(2,'0'); const yy=dt.getFullYear(); const hh=String(dt.getHours()).padStart(2,'0'); const mi=String(dt.getMinutes()).padStart(2,'0'); return `${dd}/${mm}/${yy} ${hh}:${mi}`; };
          const list = d.assignments.map(a => `
            <li>
              <div class=\"row\" style=\"justify-content:space-between\">
                <div><b>${a.title}</b><div class=\"muted\">${a.description||''}</div></div>
                <div class=\"muted\">${a.due_at?fmt(a.due_at):'‚Äî'}</div>
              </div>
              
            </li>`).join('');
          drawer.innerHTML = `
            <div class=\"row\" style=\"justify-content:space-between;align-items:center\"><b>–ó–∞–¥–∞–Ω–∏—è</b><button id=\"drawerClose\" class=\"btn ghost\">–ó–∞–∫—Ä—ã—Ç—å</button></div>
            <ul class=\"list\" style=\"margin-top:8px\">${list}</ul>
            ${(role==='owner'||role==='moderator') ? `
            <hr style=\"border:0;border-top:1px solid var(--border);margin:8px 0\"/>
            <form id=\"createAssign\">
              <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
              <input name=\"title\" required autocomplete=\"off\" />
              <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name=\"description\" autocomplete=\"off\"></textarea>
              <div class=\"row\"> 
                <div style=\"flex:1\"> <label>–î–∞—Ç–∞</label> <input type=\"date\" name=\"due_date\" autocomplete=\"off\" /> </div>
                <div style=\"width:160px\"> <label>–í—Ä–µ–º—è</label> <input type=\"time\" name=\"due_time\" autocomplete=\"off\" /> </div>
              </div>
              <button class=\"primary\" style=\"margin-top:8px\">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>`: ''}
          `;
          drawer.style.display='block';
          drawer.querySelector('#drawerClose').addEventListener('click', ()=> drawer.style.display='none');
          
          const caf = drawer.querySelector('#createAssign'); if (caf) caf.addEventListener('submit', async (e)=>{
            e.preventDefault();
            const f = new FormData(caf);
            const body = Object.fromEntries(f.entries());
            const due_at = body.due_date ? new Date(`${body.due_date}T${body.due_time||'00:00'}`).getTime() : null;
            await api(`/api/chats/${activeChatId}/assignments`, { method:'POST', body: JSON.stringify({ title: body.title, description: body.description, due_at }) });
            toast('–ó–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); document.getElementById('assignTab').click();
          });
        });
        document.getElementById('membersBtn').addEventListener('click', async ()=>{
          if (!activeChatId) return; const d = await api(`/api/chats/${activeChatId}/members`);
          const drawer = document.getElementById('drawer');
          const list = d.members.map(u => `
            <li><div class=\"row\" style=\"justify-content:space-between;gap:8px\">
              <div>${u.name} <span class=\"tag\">${u.role}</span></div>
              <div class=\"row\" style=\"gap:6px\">
                ${(role==='owner'||role==='moderator') && u.id!==currentUser.id ? `<select data-role=\"${u.id}\"> 
                  <option value=\"member\" ${u.role==='member'?'selected':''}>member</option>
                  <option value=\"moderator\" ${u.role==='moderator'?'selected':''}>moderator</option>
                </select> <button class=\"btn\" data-kick=\"${u.id}\">–ò—Å–∫–ª—é—á–∏—Ç—å</button>` : ''}
              </div>
            </div></li>`).join('');
          drawer.innerHTML = `
            <div class=\"row\" style=\"justify-content:space-between;align-items:center\"><b>–£—á–∞—Å—Ç–Ω–∏–∫–∏</b><button id=\"drawerClose\" class=\"btn ghost\">–ó–∞–∫—Ä—ã—Ç—å</button></div>
            <form id=\"inviteForm\" class=\"row\" style=\"margin:8px 0\"><input name=\"email\" placeholder=\"Email —É—á–∞—Å—Ç–Ω–∏–∫–∞\" autocomplete=\"off\" /><button class=\"primary\" type=\"submit\">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button></form>
            <ul class=\"list\">${list}</ul>
          `;
          drawer.style.display='block';
          drawer.querySelector('#drawerClose').addEventListener('click', ()=> drawer.style.display='none');
          const inv = drawer.querySelector('#inviteForm'); inv.addEventListener('submit', async (e)=>{ e.preventDefault(); const q = inv.email.value.trim(); if (!q) return; const r = await api('/api/users?q=' + encodeURIComponent(q)); if (!r.users.length) return toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); await api(`/api/chats/${activeChatId}/members`, { method:'POST', body: JSON.stringify({ userId: r.users[0].id }) }); toast('–î–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç'); document.getElementById('membersBtn').click(); });
          drawer.querySelectorAll('[data-kick]').forEach(btn => btn.addEventListener('click', async (e)=>{ const uid = e.currentTarget.getAttribute('data-kick'); await api(`/api/chats/${activeChatId}/members/${uid}`, { method:'DELETE' }); toast('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª—ë–Ω'); document.getElementById('membersBtn').click(); }));
          drawer.querySelectorAll('select[data-role]').forEach(sel => sel.addEventListener('change', async (e)=>{ const uid = e.currentTarget.getAttribute('data-role'); const newRole = e.currentTarget.value; await api(`/api/chats/${activeChatId}/members`, { method:'POST', body: JSON.stringify({ userId: Number(uid), role: newRole }) }); toast('–†–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); document.getElementById('membersBtn').click(); }));
        });
        document.getElementById('createAssign').addEventListener('submit', async (e)=>{
          e.preventDefault();
          if (!(role==='owner'||role==='moderator')) return toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤','error');
          const f = new FormData(e.target);
          const body = Object.fromEntries(f.entries());
          const due_at = body.due_date ? new Date(`${body.due_date}T${body.due_time||'00:00'}`).getTime() : null;
          await api(`/api/chats/${activeChatId}/assignments`, { method:'POST', body: JSON.stringify({ title: body.title, description: body.description, due_at }) });
          toast('–ó–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
          document.getElementById('assignTab').click();
          e.target.reset();
        });
        // theme/logout already bound above
        const inv = document.getElementById('inviteForm'); if (inv) inv.addEventListener('submit', async (e)=>{ e.preventDefault(); const q = inv.email.value.trim(); if (!q) return; const r = await api('/api/users?q=' + encodeURIComponent(q)); if (!r.users.length) return toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); await api(`/api/chats/${activeChatId}/members`, { method:'POST', body: JSON.stringify({ userId: r.users[0].id }) }); toast('–î–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç'); inv.reset(); loadMembers(); });
      });
    </script>
    <script type="module" src="/app.js"></script>
  </head>
  <body>
    <div class="container" style="max-width:1600px">
      <div class="header">
        <div class="brand"><span>–ú–ê–î–ò</span></div>
        <div class="nav"><button id="themeBtn" class="theme-toggle" type="button">–¢–µ–º–∞</button></div>
      </div>
      <div class="row" style="gap:16px; align-items:stretch; flex-wrap:nowrap">
        <div class="card" style="width:64px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:12px">
          <a class="btn ghost" href="/teams.html" title="–ß–∞—Ç—ã">üí¨</a>
          <a class="btn ghost" href="/schedule.html" title="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ">üìÖ</a>
        </div>
        <div class="card sidebar" style="width:300px;min-width:260px;flex:1 1 300px;max-width:420px">
          <div class="row" style="justify-content:space-between;margin-bottom:8px">
            <b>–ö–æ–º–∞–Ω–¥—ã –∏ —á–∞—Ç—ã</b>
            <div class="row" style="gap:8px">
              <span class="tag" id="userTag" title="–ü—Ä–æ—Ñ–∏–ª—å"></span>
              <button class="tag" id="logoutBtn" type="button" title="–í—ã–π—Ç–∏">–í—ã–π—Ç–∏</button>
            </div>
          </div>
          <ul id="chatList" class="list"></ul>
          <hr style="border:0;border-top:1px solid var(--border);margin:8px 0"/>
          <form id="newGroupForm">
            <label>–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</label>
            <input name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" required />
            <button class="primary" type="submit" style="margin-top:8px">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
          </form>
          <hr style="border:0;border-top:1px solid var(--border);margin:8px 0"/>
          <form id="newDMForm">
            <label>–õ–∏—á–Ω—ã–π —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</label>
            <input name="email" placeholder="user@madi.ru" required />
            <button class="primary" type="submit" style="margin-top:8px">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
          </form>
        </div>
        <div class="card content" style="flex:2 1 520px;display:flex;flex-direction:column;min-width:0">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row" style="gap:12px;align-items:center;margin-right:12px">
              <h2 id="chatTitle" style="margin:0">–ß–∞—Ç</h2>
              <span id="roleTag" class="tag"></span>
            </div>
            <div class="row" style="gap:8px;margin-left:12px"><button id="assignTab" class="btn" type="button">–ó–∞–¥–∞–Ω–∏—è</button><button id="meetBtn" class="btn" type="button">–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</button><button id="deleteBtn" class="btn danger" type="button" style="display:none">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button></div>
          </div>
          <div id="messages" class="messages"></div>
          <div id="typing" class="muted" style="display:none;margin-top:6px"></div>
          <form id="composer" class="composer" style="margin-top:8px">
            <textarea id="composer-input" name="content" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"></textarea>
            <div class="row" style="gap:8px"><input type="file" name="file" /><button class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>
          </form>
        </div>
        <div class="card sidebar" style="width:300px">
          <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
          <form id="inviteForm" class="row" style="margin-bottom:8px">
            <input name="email" placeholder="Email —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
            <button class="primary" style="white-space:nowrap">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
          </form>
          <ul id="memberList" class="list"></ul>
        </div>
      </div>

      <div id="drawer" class="card" style="display:none;position:fixed;right:16px;top:16px;width:360px;max-width:90vw;z-index:10;max-height:85vh;overflow:auto"></div>
    </div>
  </body>
  </html>
