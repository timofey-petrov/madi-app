<!doctype html>
<html lang="—Ä—É">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–ê–î–ò ‚Äî –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</title>
    <link rel="stylesheet" href="/styles.css" />
    <script type="module">
      import { api, me, toast, initTheme, toggleTheme } from '/app.js';
      window.addEventListener('DOMContentLoaded', async () => {
        initTheme();
        const user = await me(); if (!user) return location.href = '/';
        // Hide add-event form for students
        if (user.role !== 'teacher') {
          const formCard = document.getElementById('newE').closest('.card');
          if (formCard) formCard.style.display = 'none';
        }
        async function load(){
          const params = new URLSearchParams();
          const g = document.getElementById('f_group').value.trim();
          if (g) params.set('group', g);
          const d = await api('/api/schedule?' + params.toString());
          const ul = document.getElementById('elist'); ul.innerHTML = '';
          d.events.forEach(e => {
            const li = document.createElement('li');
            li.innerHTML = `<div class="row" style="justify-content:space-between">
              <div><b>${e.title}</b><div class="muted">${e.group_name || ''} ${e.course || ''}</div></div>
              <div class="muted">${new Date(e.starts_at).toLocaleString()} ‚Äì ${new Date(e.ends_at).toLocaleString()} @ ${e.location || ''}</div>
            </div>`;
            ul.appendChild(li);
          });
        }
        document.getElementById('loadBtn').addEventListener('click', load);
        if (user.role === 'teacher') {
          document.getElementById('newE').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const f = new FormData(e.target); const body = Object.fromEntries(f.entries());
            const s = body.starts_date ? new Date(`${body.starts_date}T${body.starts_time||'00:00'}`).getTime() : null;
            const eend = body.ends_time ? new Date(`${body.starts_date}T${body.ends_time}`).getTime() : null;
            await api('/api/schedule', { method:'POST', body: JSON.stringify({ group_name: body.group_name, title: body.title, starts_at: s, ends_at: eend, location: body.location, notes: body.notes }) });
            e.target.reset(); toast('–°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); load();
          });
        }
        load();
        document.getElementById('themeBtn').addEventListener('click', toggleTheme);
      });
    </script>
    <script type="module" src="/app.js"></script>
  </head>
  <body>
    <div class="container" style="max-width:1600px">
      <div class="header">
        <div class="brand"><span>–ú–ê–î–ò</span></div>
        <div class="nav"><button id="themeBtn" class="theme-toggle">–¢–µ–º–∞</button></div>
      </div>
      <div class="row" style="gap:16px; align-items:stretch; flex-wrap:nowrap">
        <div class="card" style="width:64px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:12px">
          <a class="btn ghost" href="/teams.html" title="–ß–∞—Ç—ã">üí¨</a>
          <a class="btn ghost" href="/schedule.html" title="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ">üìÖ</a>
        </div>
        <div class="card" style="flex:1 1 520px">
          <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</h3>
          <form id="newE">
            <label>–ì—Ä—É–ø–ø–∞</label>
            <input name="group_name" placeholder="–ò–í–ß-21" autocomplete="off" />
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name="title" placeholder="–õ–µ–∫—Ü–∏—è" required autocomplete="off" />
            <div class="row">
              <div style="flex:1">
                <label>–î–∞—Ç–∞</label>
                <input type="date" name="starts_date" required />
              </div>
              <div style="width:160px">
                <label>–í—Ä–µ–º—è</label>
                <input type="time" name="starts_time" />
              </div>
              <div style="width:160px">
                <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
                <input type="time" name="ends_time" />
              </div>
            </div>
            <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
            <input name="location" placeholder="–ê-101" />
            <label>–ó–∞–º–µ—Ç–∫–∏</label>
            <textarea name="notes" placeholder="–ü—Ä–∏–Ω–µ—Å—Ç–∏ —Ç–µ—Ç—Ä–∞–¥—å"></textarea>
            <button class="primary" style="margin-top:8px">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
        </div>
        <div class="card" style="flex:1 1 520px">
          <h3>–§–∏–ª—å—Ç—Ä –∏ —Å–ø–∏—Å–æ–∫</h3>
          <div class="row">
            <input id="f_group" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≥—Ä—É–ø–ø–µ" />
            <button id="loadBtn" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
          <ul id="elist" class="list" style="margin-top:8px"></ul>
        </div>
      </div>
    </div>
  </body>
  </html>
